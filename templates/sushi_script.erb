#!/bin/bash -e
# Managed by Puppet

if [[ "$EUID" -ne 0 ]]; then
	echo "Must be run as root, otherwise won't be able to load env vars." >&2
	exit 2
fi

if [[ -z "$vhost" ]]; then
	echo "Must pass a vhost parameter, exiting." >&2
	exit 2
fi

# Sets the environment variables
for conf in <%= @cli_root %>/"$vhost"/*.conf
do
	source $conf
done

# Use www directory to ensure correct release is used unless a release is specified
if [[ -z "$release" ]]; then
	RELEASE_DIR=<%= @vhost_root %>/"$vhost"/www/
else
	RELEASE_DIR="$release"/
fi

if [ -f "$RELEASE_DIR"/framework/sake ]; then
	SAKE_PATH="$RELEASE_DIR"/framework/sake
elif [ -f "$RELEASE_DIR"/vendor/bin/sake ]; then
	SAKE_PATH="$RELEASE_DIR"/vendor/bin/sake
else
	echo "No valid sake path found, exiting" >&2
	exit 2
fi

# Make sure it is executable
chmod +x "$SAKE_PATH"

# Preserves env
sudo -E -u www-data "$SAKE_PATH" "$@"
